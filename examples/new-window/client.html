<!Doctype html>
<html>
	<head>
		<title>Send data from client to server</title>
	</head>
	<body>
		<h1>Cross Query "Client"</h1>
		<h2>new window example</h2>
		<div style="width: 90%; margin: 0 auto">
			<h3>Send Data</h3>
			<input type="text" id="send-data" style="float: left; margin: 0 2% 0 0; width: 75%; display:block;"/>
			<input type="submit" id="send-submit" style="float: right; margin: 0; width: 22%; display: block;" >
			<div style="clear:both;"></div><!-- crappy clearfixy thing until this is actually styled -->
			<h3>You've sent:</h3>
			<div id="sent-data"></div>
		</div>
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script type="text/javascript" src="../../build/xqClient.min.js"></script>
		<!--[if lt IE 10]>
			<script type="text/javascript" src="../../build/proxy/xqIEProxyClient.min.js"></script>
		<![endif]-->
		<script id="example-script" type="text/javascript">
			(function(){
				//Vars and some cached element references.
				var serverWindow,
					$result = $( '#sent-data' ),
					$text = $( '#send-data' ),
					$button = $( '#send-submit' );
					winURL = 'http://lkwdwrd.github.io/cross-query/examples/new-window/server.html';
					winArgs = {
						window: true,
						attrs: 'width=600,height=450'
					};
				/**
				 * Send data to the frame using Cross Query.
				 * 
				 * @return {void}
				 */
				function sendData(){
					if ( ! serverWindow ){
						serverWindow = xq( winURL, winArgs );
						serverWindow.query( {action: 'openConnection' }, { timeout: -1 } )
							.progress( recieveData );
					}
					serverWindow.query( {action: 'print', data: $text.val() } );
					$text.val('');
				}
				/**
				 * Escapes entities in a string to prevent injection. Adapted from Underscorejs.
				 * 
				 * @param  {string} string The string to escape
				 * @return {string}        The escaped string.
				 */
				function escapeText(string) {
					var entityMap = {
						'&': '&amp;',
						'<': '&lt;',
						'>': '&gt;',
						'"': '&quot;',
						"'": '&#x27;'
					};
					var entityReg = /[&<>"']/g;

					if (string == null) return '';
					return ( '' + string ).replace( entityReg, function(match) {
						return entityMap[match];
					});
				};
				/**
				 * Send data to the frame using Cross Query.
				 * 
				 * @return {void}
				 */
				function recieveData( data ){
					$result.html( $result.html() + '<p>' + escapeText( data ) + '</p>' );
				}
				// OK, we have all the pieces, fire up Cross Query and attach the event to the button.
				$button.on( 'click', sendData );
			})();
		</script>
	</body>
</html>