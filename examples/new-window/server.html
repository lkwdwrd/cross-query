<!Doctype html>
<html>
	<head>
		<title>Cross Query Server</title>
	</head>
	<body>
		<h1>Cross Query Server</h1>
		<div style="width: 90%; margin: 0 auto">
			<h3>Send data:</h3>
			<input type="text" id="send-data" style="float: left; margin: 0 2% 0 0; width: 75%; display:block;"/>
			<input type="submit" id="send-submit" style="float: right; margin: 0; width: 20%; display: block;" >
			<div style="clear:both;"></div><!-- crappy clearfixy thing until this is actually styled -->
			<h3>You've sent:</h3>
			<div id="data-sent"></div>
		</div>
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script type="text/javascript" src="../../build/xqServer.js"></script>
		<!--[if lt IE 10]>
			<script type="text/javascript" src="../../build/proxy/xqIEProxyServer.min.js"></script>
		<![endif]-->
		<script id="example-script" type="text/javascript">
			(function(){
				//Vars and some cached element references.
				var serverRef, notifyMethod,
					$text = $( '#send-data' ),
					$button = $( '#send-submit' ),
					$sentDiv = $( '#data-sent' );
				/**
				 * Escapes entities in a string to prevent injection. Adapted from Underscorejs.
				 * 
				 * @param  {string} string The string to escape
				 * @return {string}        The escaped string.
				 */
				function escapeText(string) {
					var entityMap = {
						'&': '&amp;',
						'<': '&lt;',
						'>': '&gt;',
						'"': '&quot;',
						"'": '&#x27;'
					};
					var entityReg = /[&<>"']/g;

					if (string == null) return '';
					return ( '' + string ).replace( entityReg, function(match) {
						return entityMap[match];
					});
				};
				/**
				 * Send data to the frame using Cross Query.
				 * 
				 * @return {void}
				 */
				function printData( data ){
					$sentDiv.html( $sentDiv.html() + '<p>' + escapeText( data ) + '</p>' );
				}
				/**
				 * Send data to the frame using Cross Query.
				 * 
				 * @return {void}
				 */
				function openConnection(){
					notifyMethod = this.sendNotification;
					$button.on( 'click', sendData );
					$(window).on( 'unload', closeWindow( this.sendSuccess ) );
				}
				/**
				 * Sends the actual notification back to the parent frame using the cached notify method.
				 * 
				 * @return {void}
				 */
				function sendData(){
					notifyMethod( $text.val() );
					$text.val('');
				}
				/**
				 * Helper method to send a message to the main window that this one is closing.
				 *
				 * @param  {Function} The function to send on close.
				 * @return {Function} The function to use as the unload handler.
				 */
				function closeWindow( successMethod ) {
					return function(){ successMethod() };
				}
				// OK, we have all the pieces, fire up Cross Query's server.
				// Note that storing the serverRef is not explicitly necessary here, but it's a good idea.
				serverRef = xqServer( {
					openConnection: openConnection,
					print: printData
				}, ['http://lkwdwrd.github.io' ] );
			})();
		</script>
	</body>
</html>