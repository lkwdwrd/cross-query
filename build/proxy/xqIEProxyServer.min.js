/*! Cross Query - v0.2.0
 * 
 * Copyright (c) 2014; * Licensed GPLv2+ */
!function(a){"use strict";function b(a){var b;for(b in a)"function"==typeof a[b]&&(C[b]=a[b]);return C.xqDeactivate=h,g(),{addAction:c,removeAction:d}}function c(a,b){"string"==typeof a&&"function"==typeof b&&(C[a]=b)}function d(a){"string"==typeof a&&C[a]&&delete C[a]}function e(){var a,b,c,d;if(y&&(a=q(G))){b=q(a)||"";try{if("string"!=typeof b)return;c=JSON.parse(b)}catch(e){return}"object"==typeof c&&c.callID&&(d={sendSuccess:f(!0,c.callID),sendFail:f(!1,c.callID),sendNotification:f("notify",c.callID)},C[a]||d.sendFail("No callable action was sent"),C[a].call(d,c.data))}}function f(a,b){return function(c){var d={success:a,data:c};r(G+"-return",b,JSON.stringify(d))}}function g(){y=!0,a.localStorage.setItem(H,"active")}function h(){function a(){b()}var b=this.sendSuccess;t(a)}function i(a,b){x=F({xqProxyActivate:k,proxyCall:l},b),y=!0}function j(){var a,b,c,d,e;if(""!==H){if(!z)return void m();if(a=q(G+"-return"),a&&(b=q(a)||"",E[a])){e=E[a];try{if("string"!=typeof b)return void e.sendFail({error:"Unable to decode data"});c=JSON.parse(b)}catch(f){return void e.sendFail({error:"Unable to decode data"})}"object"!=typeof c&&e.sendFail({error:"Unable to decode data"}),"notify"===c.success?d="sendNotification":(d=c.success?"sendSuccess":"sendFail",delete E[a]),e[d](c.data)}}}function k(a){t(this.sendSuccess),p(a),m(),l.call({sendSuccess:n,sendFail:n},{action:"xqDeactivate"})}function l(a){if(!z||A)return void D.push({context:this,data:a});var b={callID:a.action+J,data:a.data};E[b.callID]=this,J++,r(G,a.action,JSON.stringify(b)),u()}function m(){"active"===q(H)&&(z=!0,w())}function n(){z=!1,l.call({sendSuccess:n,sendFail:n},{action:"xqDeactivate"})}function o(){y&&(B?j():e())}function p(a){G=a.substr(0,24),H=a.substr(12,12),I=a.substr(24)}function q(b){var c=a.localStorage.getItem(b);return a.localStorage.removeItem(b),xqServer.decrypt(c,I)}function r(b,c,d){a.localStorage.setItem(c,xqServer.crypt(d)),a.localStorage.setItem(b,c)}function s(a){return a}function t(b){a.addEventListener?a.addEventListener("unload",b,!1):a.attachEvent&&a.attachEvent("onunload",b)}function u(){A=!0,a.setTimeout(v,80)}function v(){A=!1,w()}function w(){var a=D.shift();z&&a&&l.call(a.context,a.data)}var x,y=!1,z=!1,A=!1,B=!a.opener,C={},D=[],E={},F=a.xqServer,G="",H="",I="",J=0;B?a.xqServer=i:(a.xqServer=b,p(a.name)),a.xqServer.crypt=s,a.xqServer.decrypt=s,a.addEventListener?a.addEventListener("storage",o,!1):a.attachEvent&&a.document.attachEvent("onstorage",o)}(window,document,void 0);